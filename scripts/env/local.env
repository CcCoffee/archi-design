#!/bin/bash

#######################################
# Redis Cluster 环境配置 - 本地开发环境
# 用途: MacBook 本地多端口模拟集群
# 说明: 在单机上使用不同端口模拟多节点集群
#######################################

# 环境标识
export ENV_TYPE="local"
export ENV_NAME="本地开发环境"

# 基础配置
export REDIS_BASE_DIR="${HOME}/.redis-cluster"
export REDIS_DATA_DIR="${REDIS_BASE_DIR}/data"
export REDIS_LOG_DIR="${REDIS_BASE_DIR}/logs"
export REDIS_CONF_DIR="${REDIS_BASE_DIR}/conf"
export REDIS_PID_DIR="${REDIS_BASE_DIR}/pids"

# 集群配置
export CLUSTER_NAME="redis-cluster-local"
export CLUSTER_PASSWORD=""  # 本地开发可不设置密码
export CLUSTER_REQUIRE_FULL_COVERAGE="no"  # 允许部分槽位不可用时继续服务

# 节点配置 - 模拟双数据中心
# DC-A (主数据中心) - 3个主节点
export DC_A_NAME="DC-A"
export DC_A_NODES=(
    "127.0.0.1:7000"
    "127.0.0.1:7001"
    "127.0.0.1:7002"
)

# DC-B (备数据中心) - 3个从节点
export DC_B_NAME="DC-B"
export DC_B_NODES=(
    "127.0.0.1:7003"
    "127.0.0.1:7004"
    "127.0.0.1:7005"
)

# 所有节点
export ALL_NODES=("${DC_A_NODES[@]}" "${DC_B_NODES[@]}")

# 主从映射关系 (从节点索引 -> 主节点索引)
# Node-4(7003) -> Node-1(7000)
# Node-5(7004) -> Node-2(7001)
# Node-6(7005) -> Node-3(7002)
export REPLICA_MAPPING=(
    "7003:7000"
    "7004:7001"
    "7005:7002"
)

# 槽位分配
export SLOTS_NODE_1="0-5460"
export SLOTS_NODE_2="5461-10922"
export SLOTS_NODE_3="10923-16383"

# Redis 配置参数
export REDIS_MAXMEMORY="256mb"
export REDIS_MAXMEMORY_POLICY="allkeys-lru"
export REDIS_TIMEOUT="0"
export REDIS_TCP_KEEPALIVE="300"
export REDIS_DAEMONIZE="yes"
export REDIS_LOGLEVEL="notice"

# 集群参数
export CLUSTER_ENABLED="yes"
export CLUSTER_CONFIG_FILE="nodes.conf"
export CLUSTER_NODE_TIMEOUT="5000"
export CLUSTER_SLAVE_VALIDITY_FACTOR="10"
export CLUSTER_MIGRATION_BARRIER="1"
export CLUSTER_ANNOUNCE_IP=""  # 本地环境留空
export CLUSTER_ANNOUNCE_PORT=""  # 本地环境留空
export CLUSTER_ANNOUNCE_BUS_PORT=""  # 本地环境留空

# 复制参数
export REPLICA_SERVE_STALE_DATA="yes"
export REPLICA_READ_ONLY="yes"
export REPLICA_PRIORITY="100"

# 持久化参数
export SAVE_POLICY="900 1 300 10 60 10000"
export APPENDONLY="yes"
export APPENDFSYNC="everysec"
export AUTO_AOF_REWRITE_PERCENTAGE="100"
export AUTO_AOF_REWRITE_MIN_SIZE="64mb"

# 监控配置
export MONITOR_INTERVAL="5"
export HEALTH_CHECK_TIMEOUT="3"

# 日志配置
export LOG_MAX_SIZE="100M"
export LOG_MAX_FILES="5"
