#!/bin/bash

#######################################
# Redis Cluster 环境配置 - 生产环境
# 用途: 双数据中心生产环境部署
# 说明: 跨数据中心的真实生产环境配置
#######################################

# 环境标识
export ENV_TYPE="production"
export ENV_NAME="生产环境"

# 基础配置
export REDIS_BASE_DIR="/opt/redis-cluster"
export REDIS_DATA_DIR="${REDIS_BASE_DIR}/data"
export REDIS_LOG_DIR="${REDIS_BASE_DIR}/logs"
export REDIS_CONF_DIR="${REDIS_BASE_DIR}/conf"
export REDIS_PID_DIR="/var/run/redis-cluster"

# 集群配置
export CLUSTER_NAME="redis-cluster-prod"
export CLUSTER_PASSWORD=""  # 请在生产环境设置强密码
export CLUSTER_REQUIRE_FULL_COVERAGE="yes"  # 生产环境要求完整槽位覆盖

# 数据中心 A (主数据中心)
export DC_A_NAME="DC-A"
export DC_A_VIP="10.1.1.100"
export DC_A_SUBNET="10.1.1.0/24"
export DC_A_NODES=(
    "10.1.1.1:6379"
    "10.1.1.2:6379"
    "10.1.1.3:6379"
)

# 数据中心 B (备数据中心)
export DC_B_NAME="DC-B"
export DC_B_VIP="10.2.1.100"
export DC_B_SUBNET="10.2.1.0/24"
export DC_B_NODES=(
    "10.2.1.1:6379"
    "10.2.1.2:6379"
    "10.2.1.3:6379"
)

# 所有节点
export ALL_NODES=("${DC_A_NODES[@]}" "${DC_B_NODES[@]}")

# 主从映射关系 (从节点 -> 主节点)
export REPLICA_MAPPING=(
    "10.2.1.1:6379:10.1.1.1:6379"
    "10.2.1.2:6379:10.1.1.2:6379"
    "10.2.1.3:6379:10.1.1.3:6379"
)

# 槽位分配
export SLOTS_NODE_1="0-5460"
export SLOTS_NODE_2="5461-10922"
export SLOTS_NODE_3="10923-16383"

# Redis 配置参数
export REDIS_MAXMEMORY="4gb"
export REDIS_MAXMEMORY_POLICY="volatile-lru"
export REDIS_TIMEOUT="0"
export REDIS_TCP_KEEPALIVE="300"
export REDIS_DAEMONIZE="yes"
export REDIS_LOGLEVEL="notice"

# 集群参数
export CLUSTER_ENABLED="yes"
export CLUSTER_CONFIG_FILE="nodes.conf"
export CLUSTER_NODE_TIMEOUT="5000"
export CLUSTER_SLAVE_VALIDITY_FACTOR="10"
export CLUSTER_MIGRATION_BARRIER="1"
export CLUSTER_ANNOUNCE_IP=""  # 自动检测或手动设置
export CLUSTER_ANNOUNCE_PORT=""
export CLUSTER_ANNOUNCE_BUS_PORT=""

# 复制参数
export REPLICA_SERVE_STALE_DATA="no"  # 生产环境建议关闭
export REPLICA_READ_ONLY="yes"
export REPLICA_PRIORITY="100"

# 持久化参数
export SAVE_POLICY="900 1 300 10 60 10000"
export APPENDONLY="yes"
export APPENDFSYNC="everysec"
export AUTO_AOF_REWRITE_PERCENTAGE="100"
export AUTO_AOF_REWRITE_MIN_SIZE="64mb"

# 安全配置
export PROTECTED_MODE="yes"
export BIND_ADDRESS="0.0.0.0"

# 监控配置
export MONITOR_INTERVAL="10"
export HEALTH_CHECK_TIMEOUT="5"

# 日志配置
export LOG_MAX_SIZE="500M"
export LOG_MAX_FILES="10"

# 告警配置
export ALERT_EMAIL="ops@company.com"
export ALERT_WEBHOOK=""  # 钉钉/企业微信 webhook

# 备份配置
export BACKUP_DIR="/opt/redis-cluster/backups"
export BACKUP_RETENTION_DAYS="7"
export BACKUP_CRON="0 2 * * *"  # 每天凌晨2点备份
